<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Eye Health</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Sidebar Navigation (Desktop) -->
  <nav class="sidebar-nav">
    <div style="margin-bottom: 32px; padding: 12px;">
      <h2 style="font-size: 20px; font-weight: bold; color: #1D4ED8;">Smart Eye Health</h2>
    </div>
    <a href="index.html" class="nav-item active">
      <div class="nav-icon">ğŸ </div>
      <div class="nav-label">í™ˆ</div>
    </a>
    <a href="dashboard.html" class="nav-item">
      <div class="nav-icon">ğŸ“Š</div>
      <div class="nav-label">ëŒ€ì‹œë³´ë“œ</div>
    </a>
    <a href="smartlens.html" class="nav-item">
      <div class="nav-icon">ğŸ‘“</div>
      <div class="nav-label">ìŠ¤ë§ˆíŠ¸ë Œì¦ˆ</div>
    </a>
    <a href="settings.html" class="nav-item">
      <div class="nav-icon">âš™ï¸</div>
      <div class="nav-label">ì„¤ì •</div>
    </a>
  </nav>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="location-time">
        <span class="location-icon">ğŸ“</span>
        <span id="currentTime">Seoul, 10:40 AM</span>
      </div>
    </div>

    <!-- Mode Toggle -->
    <div class="mode-toggle">
      <button class="mode-btn active" onclick="setMode('working')">ìš´ì „ ëª¨ë“œ</button>
      <button class="mode-btn" onclick="setMode('driving')">ì‘ì—… ëª¨ë“œ</button>
    </div>

    <!-- Main Gauge -->
    <div class="card" style="text-align: center;">
      <div class="gauge-container">
        <svg class="gauge-svg" viewBox="0 0 240 240" preserveAspectRatio="xMidYMid meet">
          <circle class="gauge-bg" cx="120" cy="120" r="108"></circle>
          <circle id="gaugeFill" class="gauge-fill" cx="120" cy="120" r="108"></circle>
        </svg>
        <div class="gauge-value">
          <div class="gauge-label">ëˆˆ í”¼ë¡œë„</div>
          <div class="gauge-number" id="fatigueValue"></div>
        </div>
      </div>
      <div class="status-badge" id="fatigueStatusBadge"></div>
    </div>

    <!-- Alert Tags -->
    <div class="alert-tags" id="fatigueAlertTags">
      <!-- Dynamic content will be inserted here -->
    </div>

    <!-- Sensor Data -->
    <div class="sensor-grid">
      <div class="card sensor-card">
        <div class="sensor-label">ì•ˆì••</div>
        <div class="sensor-value" id="pressureValue"></div>
        <div class="sensor-unit">mmHg</div>
      </div>
      <div class="card sensor-card">
        <div class="sensor-label">ì¡°ë„</div>
        <div class="sensor-value" id="brightnessValue"></div>
        <div class="sensor-unit">lux</div>
      </div>
      <div class="card sensor-card">
        <div class="sensor-label">ê¹œë¹¡ì„</div>
        <div class="sensor-value" id="blinkValue"></div>
        <div class="sensor-unit">/min</div>
      </div>
    </div>

    <!-- Insights -->
    <div class="section">
      <div class="section-title">ìµœê·¼ ì„¼ì„œ ìš”ì•½</div>
      <div id="fatigueInsights">
        <!-- Dynamic content will be inserted here -->
      </div>
    </div>

    <!-- 30ë¶„ ì¶”ì´ -->
    <div class="section">
      <div class="section-title">30ë¶„ ì¶”ì´</div>
      <div class="card">
        <div class="chart-row">
          <div class="chart-label">í”¼ë¡œë„</div>
          <div class="chart-badge" id="fatigueChartBadge"></div>
        </div>
        <div class="mini-chart">
          <canvas id="fatigueChart" width="400" height="40"></canvas>
        </div>

        <div class="chart-row">
          <div class="chart-label">ì•ˆì••</div>
          <div class="chart-badge" style="color: #3B82F6;">ì•ˆì •</div>
        </div>
        <div class="mini-chart">
          <canvas id="pressureChart" width="400" height="40"></canvas>
        </div>

        <div class="chart-row">
          <div class="chart-label">ê¹œë¹¡ì„</div>
          <div class="chart-badge" style="color: #F59E0B;">ê°ì†Œ</div>
        </div>
        <div class="mini-chart">
          <canvas id="blinkChart" width="400" height="40"></canvas>
        </div>
      </div>
    </div>

    <!-- Alert Button -->
    <button class="btn btn-primary btn-full">
      ğŸ”” ê²½ë³´ ì‹œìŠ¤í…œ í™œì„±í™”
    </button>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item active">
      <div class="nav-icon">ğŸ </div>
      <div class="nav-label">í™ˆ</div>
    </a>
    <a href="dashboard.html" class="nav-item">
      <div class="nav-icon">ğŸ“Š</div>
      <div class="nav-label">ëŒ€ì‹œë³´ë“œ</div>
    </a>
    <a href="smartlens.html" class="nav-item">
      <div class="nav-icon">ğŸ‘“</div>
      <div class="nav-label">ë Œì¦ˆ</div>
    </a>
    <a href="settings.html" class="nav-item">
      <div class="nav-icon">âš™ï¸</div>
      <div class="nav-label">ì„¤ì •</div>
    </a>
  </nav>

  <script src="js/sensor.js"></script>
  <script>
    // í”¼ë¡œë„ ë ˆë²¨ì— ë”°ë¥¸ ìƒ‰ìƒ ë° í…ìŠ¤íŠ¸ ë§¤í•‘
    function getFatigueLevelInfo(level) {
      switch (level) {
        case 'Red':
          return { text: 'ë§¤ìš° í”¼ê³¤', bgColor: '#FEE2E2', textColor: '#991B1B', chartColor: '#EF4444' };
        case 'Orange':
          return { text: 'í”¼ê³¤', bgColor: '#FEF3C7', textColor: '#92400E', chartColor: '#F59E0B' };
        case 'Yellow':
          return { text: 'ë³´í†µ', bgColor: '#FFFBEB', textColor: '#B45309', chartColor: '#FFD700' };
        case 'Green':
          return { text: 'ì–‘í˜¸', bgColor: '#D1FAE5', textColor: '#065F46', chartColor: '#10B981' };
        default:
          return { text: 'ì•Œ ìˆ˜ ì—†ìŒ', bgColor: '#F9FAFB', textColor: '#1F2937', chartColor: '#FFB800' };
      }
    }

    // ì›í˜• ê²Œì´ì§€ ê·¸ë¦¬ê¸°
    function drawGauge(value, color) {
      const radius = 108;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference * (1 - value / 100);

      document.getElementById('gaugeFill').style.strokeDasharray = circumference;
      document.getElementById('gaugeFill').style.strokeDashoffset = offset;
      document.getElementById('gaugeFill').style.stroke = color;
    }

    // ë¯¸ë‹ˆ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    function drawMiniChart(canvasId, data, color) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;

      ctx.clearRect(0, 0, width, height);

      const max = Math.max(...data);
      const min = Math.min(...data);
      const range = max - min || 1;

      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();

      data.forEach((value, index) => {
        const x = (index / (data.length - 1)) * width;
        const y = height - ((value - min) / range) * height;

        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });

      ctx.stroke();
    }

    // ë°ì´í„° ì—…ë°ì´íŠ¸
    function updateData() {
      const data = sensorManager.getCurrent();
      if (!data || !data.fatigueAnalysis) return;

      // í”¼ë¡œë„ ë¶„ì„ ê²°ê³¼
      const fatigueScore = data.fatigueAnalysis.score;
      const fatigueLevel = data.fatigueAnalysis.level;
      const fatigueLevelInfo = getFatigueLevelInfo(fatigueLevel);

      document.getElementById('fatigueValue').textContent = fatigueScore;
      drawGauge(fatigueScore, fatigueLevelInfo.chartColor);

      const statusBadge = document.getElementById('fatigueStatusBadge');
      statusBadge.textContent = fatigueLevelInfo.text;
      statusBadge.style.backgroundColor = fatigueLevelInfo.bgColor;
      statusBadge.style.color = fatigueLevelInfo.textColor;

      // Alert Tags ì—…ë°ì´íŠ¸
      const alertTagsContainer = document.getElementById('fatigueAlertTags');
      alertTagsContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê¸°
      data.fatigueAnalysis.factors.forEach(factor => {
        const tag = document.createElement('div');
        tag.className = 'alert-tag';
        let icon = '';
        let bgColor = '#E0F2FE'; // Default info color
        if (factor.impact === 'increase') {
          bgColor = '#FEE2E2'; // Danger
          icon = 'âš ï¸';
        } else if (factor.impact === 'decrease') {
          bgColor = '#D1FAE5'; // Success
          icon = 'âœ…';
        }
        tag.style.backgroundColor = bgColor;
        tag.innerHTML = `${icon} ${factor.description}${factor.impact === 'increase' ? 'â†‘' : factor.impact === 'decrease' ? 'â†“' : ''}`;
        alertTagsContainer.appendChild(tag);
      });

      // ì„¼ì„œ ë°ì´í„° (ê³ ì • ê°’)
      document.getElementById('pressureValue').textContent = data.eyePressure;
      document.getElementById('brightnessValue').textContent = data.brightness;
      document.getElementById('blinkValue').textContent = data.blinkRate;
      document.getElementById('currentBrightness').textContent = data.brightness; // ì¸ì‚¬ì´íŠ¸ìš©

      // ì¸ì‚¬ì´íŠ¸ ì—…ë°ì´íŠ¸
      const insightsContainer = document.getElementById('fatigueInsights');
      insightsContainer.innerHTML = '';
      data.fatigueAnalysis.recommendations.forEach(rec => {
        const insightCard = document.createElement('div');
        insightCard.className = 'card insight-card info';
        insightCard.innerHTML = `
          <div class="insight-icon">ğŸ’¡</div>
          <div class="insight-content">
            <div class="insight-title">ê¶Œì¥ ì‚¬í•­</div>
            <div class="insight-text">${rec}</div>
          </div>
        `;
        insightsContainer.appendChild(insightCard);
      });

      // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
      const history = sensorManager.getHistory();
      const fatigueData = history.map(d => d.fatigueScore);
      const pressureData = history.map(d => d.eyePressure * 10);
      const blinkData = history.map(d => d.blinkRate * 5);

      document.getElementById('fatigueChartBadge').textContent = fatigueLevelInfo.text;
      document.getElementById('fatigueChartBadge').style.color = fatigueLevelInfo.chartColor;
      drawMiniChart('fatigueChart', fatigueData.slice(-30), fatigueLevelInfo.chartColor);
      drawMiniChart('pressureChart', pressureData.slice(-30), '#3B82F6');
      drawMiniChart('blinkChart', blinkData.slice(-30), '#F59E0B');
    }

    // ëª¨ë“œ ë³€ê²½ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    function setMode(mode) {
      sensorManager.setMode(mode);
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }

    // ì‹œê°„ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    function updateTime() {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const displayHours = hours % 12 || 12;

      document.getElementById('currentTime').textContent =
        `Seoul, ${displayHours}:${minutes} ${ampm}`;
    }

    // ì´ˆê¸°í™”
    sensorManager.start();
    updateData();
    updateTime();
    // setInterval(updateTime, 1000); // ì •ì  ë°ì´í„°ì´ë¯€ë¡œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ëŠ” í•„ìš” ì—†ìŒ

    // ì„¼ì„œ ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì •ì  ë°ì´í„°ì´ë¯€ë¡œ í•œ ë²ˆë§Œ í˜¸ì¶œ)
    // window.addEventListener('sensorUpdate', updateData);
  </script>
</body>
</html>
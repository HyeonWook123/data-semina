<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìŠ¤ë§ˆíŠ¸ë Œì¦ˆ - Smart Eye Health</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body { background: #1F2937; color: white; }
    .container { background: #1F2937; }
  </style>
</head>
<body>
  <!-- Sidebar Navigation (Desktop) -->
  <nav class="sidebar-nav" style="background: #1F2937;">
    <div style="margin-bottom: 32px; padding: 12px;">
      <h2 style="font-size: 20px; font-weight: bold; color: #3B82F6;">Smart Eye Health</h2>
    </div>
    <a href="index.html" class="nav-item" style="color: white;">
      <div class="nav-icon">ğŸ </div>
      <div class="nav-label">í™ˆ</div>
    </a>
    <a href="dashboard.html" class="nav-item" style="color: white;">
      <div class="nav-icon">ğŸ“Š</div>
      <div class="nav-label">ëŒ€ì‹œë³´ë“œ</div>
    </a>
    <a href="smartlens.html" class="nav-item active" style="background: #374151; color: white;">
      <div class="nav-icon">ğŸ‘“</div>
      <div class="nav-label">ìŠ¤ë§ˆíŠ¸ë Œì¦ˆ</div>
    </a>
    <a href="settings.html" class="nav-item" style="color: white;">
      <div class="nav-icon">âš™ï¸</div>
      <div class="nav-label">ì„¤ì •</div>
    </a>
  </nav>

  <div class="container">
    <!-- Header -->
    <div class="header" style="color: white;">
      <button style="background: none; border: none; font-size: 24px; cursor: pointer; color: white;">â˜°</button>
      <h1 class="header-title" style="flex: 1; text-align: center; color: white;">ìŠ¤ë§ˆíŠ¸ë Œì¦ˆ</h1>
      <button style="background: none; border: none; font-size: 24px; cursor: pointer;">ğŸ””</button>
    </div>

    <!-- Device Status -->
    <div class="card" style="background: #374151; margin-bottom: 24px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
        <div style="color: white;">ğŸ“¡ ì—°ê²°ë¨</div>
        <div style="display: flex; align-items: center; gap: 4px;">
          <span>ğŸ”‹</span>
          <span id="battery" style="color: #10B981; font-weight: 600;">87%</span>
        </div>
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
        <div style="color: white;">ğŸ“± íŒì›¨ì–´ v1.2.0</div>
        <div style="color: #10B981; font-weight: 600;">ìµœì‹  ë²„ì „</div>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid #4B5563;">
        <div style="color: white;">ì‹¤ì‹œê°„ ë°ì´í„°</div>
        <div style="width: 48px; height: 28px; background: #3B82F6; border-radius: 14px; position: relative; cursor: pointer;">
          <div style="width: 24px; height: 24px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 22px;"></div>
        </div>
      </div>
    </div>

    <!-- ì‹¤ì‹œê°„ ë Œì¦ˆ ë°ì´í„° -->
    <div class="section">
      <div class="section-title" style="color: white;">ì‹¤ì‹œê°„ ë Œì¦ˆ ë°ì´í„°</div>

      <div class="card" style="background: #374151; margin-bottom: 12px;">
        <div style="font-size: 13px; color: #9CA3AF; margin-bottom: 8px;">ì•ˆêµ¬ ë¯¸ì„¸ ì••ë ¥</div>
        <div style="font-size: 24px; font-weight: bold; color: white; margin-bottom: 4px;" id="microPressure"></div>
        <div style="font-size: 12px;" id="microPressureChange"></div>
      </div>

      <div class="card" style="background: #374151; margin-bottom: 12px;">
        <div style="font-size: 13px; color: #9CA3AF; margin-bottom: 8px;">ë§ˆì´í¬ë¡œ ëª¨ì…˜</div>
        <div style="font-size: 24px; font-weight: bold; color: white; margin-bottom: 4px;" id="microMotion"></div>
        <div style="font-size: 12px; color: #10B981;">ì•ˆì •ì </div>
      </div>

      <div class="card" style="background: #374151;">
        <div style="font-size: 13px; color: #9CA3AF; margin-bottom: 8px;">ëˆˆ ê¹œë¹¡ì„ ë¹ˆë„</div>
        <div style="font-size: 24px; font-weight: bold; color: white; margin-bottom: 4px;" id="blinkFreq"></div>
        <div style="font-size: 12px; color: #10B981;">ì•ˆì •ì </div>
      </div>
    </div>

    <!-- AI ì •ë°€ ì˜ˆì¸¡ -->
    <div class="section">
      <div class="section-title" style="color: white;">AI ì •ë°€ ì˜ˆì¸¡</div>
      <div class="card" style="background: #374151; text-align: center; padding: 24px;">
        <div class="gauge-container" style="margin: 0 auto; width: 180px; height: 180px;">
          <svg class="gauge-svg" viewBox="0 0 180 180" preserveAspectRatio="xMidYMid meet" style="width: 100%; height: 100%;">
            <circle class="gauge-bg" cx="90" cy="90" r="80" style="stroke: #1F2937;"></circle>
            <circle id="riskGaugeFill" class="gauge-fill" cx="90" cy="90" r="80"></circle>
          </svg>
          <div class="gauge-value">
            <div class="gauge-number" style="color: white; font-size: 36px;" id="riskScore"></div>
          </div>
        </div>
        <div id="glaucomaRiskLevelBadge" style="margin-top: 16px; padding: 8px 24px; border-radius: 20px; color: white; font-weight: 600; font-size: 14px; display: inline-block;"></div>
        <div style="font-size: 16px; font-weight: bold; margin-top: 16px; color: white;" id="glaucomaRiskTitle"></div>
        <div style="font-size: 13px; color: #9CA3AF; margin-top: 8px;" id="glaucomaRiskDescription"></div>
      </div>

      <div class="card" style="background: #374151;" id="glaucomaFactorsCard">
        <!-- Dynamic content will be inserted here -->
      </div>
    </div>

    <!-- í™œë™ ê¸°ë¡ -->
    <div class="section">
      <div class="section-title" style="color: white;">í™œë™ ê¸°ë¡</div>
      <div id="glaucomaActivityLog">
        <!-- Dynamic content will be inserted here -->
      </div>
      <div style="font-size: 13px; color: #D1D5DB; margin-bottom: 16px; line-height: 1.4;">
        ì•ˆì „í•œ ì‚¬ìš©ì„ ìœ„í•´ ì¦‰ì‹œ íœ´ì‹ í•˜ê±°ë‚˜ ë Œì¦ˆë¥¼ ì œì¡°ì •í•˜ì„¸ìš”.
      </div>
      <div style="display: flex; gap: 12px;">
        <button class="btn btn-primary" style="flex: 1;">ë Œì¦ˆ ì •ë°€ ê°€ì´ë“œ ë³´ê¸°</button>
        <button class="btn btn-secondary" style="flex: 1;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item">
      <div class="nav-icon">ğŸ </div>
      <div class="nav-label">í™ˆ</div>
    </a>
    <a href="dashboard.html" class="nav-item">
      <div class="nav-icon">ğŸ“Š</div>
      <div class="nav-label">ëŒ€ì‹œë³´ë“œ</div>
    </a>
    <a href="smartlens.html" class="nav-item active">
      <div class="nav-icon">ğŸ‘“</div>
      <div class="nav-label">ë Œì¦ˆ</div>
    </a>
    <a href="settings.html" class="nav-item">
      <div class="nav-icon">âš™ï¸</div>
      <div class="nav-label">ì„¤ì •</div>
    </a>
  </nav>

  <script src="js/sensor.js"></script>
  <script>
    // ë…¹ë‚´ì¥ ìœ„í—˜ ë ˆë²¨ì— ë”°ë¥¸ ìƒ‰ìƒ ë° í…ìŠ¤íŠ¸ ë§¤í•‘ (smartlens.htmlì—ì„œ ê°€ì ¸ì˜´)
    function getGlaucomaRiskLevelInfo(level) {
      switch (level) {
        case 'HIGH':
          return { text: 'ë†’ìŒ', bgColor: '#EF4444', textColor: 'white', chartColor: '#EF4444' };
        case 'MEDIUM':
          return { text: 'ì¤‘ê°„', bgColor: '#F59E0B', textColor: 'white', chartColor: '#F59E0B' };
        case 'LOW':
          return { text: 'ë‚®ìŒ', bgColor: '#10B981', textColor: 'white', chartColor: '#10B981' };
        default:
          return { text: 'ì•Œ ìˆ˜ ì—†ìŒ', bgColor: '#6B7280', textColor: 'white', chartColor: '#EF4444' };
      }
    }

    function drawRiskGauge(value, color) {
      const radius = 80;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference * (1 - value / 100);

      document.getElementById('riskGaugeFill').style.strokeDasharray = circumference;
      document.getElementById('riskGaugeFill').style.strokeDashoffset = offset;
      document.getElementById('riskGaugeFill').style.stroke = color;
    }

    function updateData() {
      const data = sensorManager.getCurrent();
      if (!data || !data.glaucomaAnalysis) return;

      // --- ì‹¤ì‹œê°„ ë Œì¦ˆ ë°ì´í„° ì—…ë°ì´íŠ¸ ---
      document.getElementById('microPressure').textContent = `${data.eyePressure} mmHg`;
      document.getElementById('microMotion').textContent = `${data.microMotion} mm/s`;
      document.getElementById('blinkFreq').textContent = `${data.blinkRate} íšŒ/ë¶„`;

      // ì•ˆêµ¬ ë¯¸ì„¸ ì••ë ¥ ë³€í™” (ë…¹ë‚´ì¥ ìš”ì¸ ê¸°ë°˜)
      const intraocularPressureFactor = data.glaucomaAnalysis.factors.find(f => f.name === 'intraocularPressure');
      const microPressureChangeElement = document.getElementById('microPressureChange');
      if (intraocularPressureFactor) {
        microPressureChangeElement.textContent = intraocularPressureFactor.impact === 'increase' ? 'ìœ„í—˜ ì¦ê°€' : 'ìœ„í—˜ ê°ì†Œ';
        microPressureChangeElement.style.color = intraocularPressureFactor.impact === 'increase' ? '#EF4444' : '#10B981';
      } else {
        microPressureChangeElement.textContent = 'ì •ë³´ ì—†ìŒ';
        microPressureChangeElement.style.color = '#9CA3AF';
      }

      // --- AI ì •ë°€ ì˜ˆì¸¡ ì—…ë°ì´íŠ¸ ---
      const glaucomaProbability = data.glaucomaAnalysis.probability;
      const glaucomaLevel = data.glaucomaAnalysis.level;
      const glaucomaLevelInfo = getGlaucomaRiskLevelInfo(glaucomaLevel);

      document.getElementById('riskScore').textContent = Math.round(glaucomaProbability * 100);
      drawRiskGauge(glaucomaProbability * 100, glaucomaLevelInfo.chartColor);

      const riskLevelBadge = document.getElementById('glaucomaRiskLevelBadge');
      riskLevelBadge.textContent = glaucomaLevelInfo.text;
      riskLevelBadge.style.backgroundColor = glaucomaLevelInfo.bgColor;
      riskLevelBadge.style.color = glaucomaLevelInfo.textColor;

      document.getElementById('glaucomaRiskTitle').textContent = `í˜„ì¬ ìœ„í—˜ë„: ${glaucomaLevelInfo.text}`;
      document.getElementById('glaucomaRiskDescription').textContent = data.glaucomaAnalysis.recommendations[0] || 'ì£¼ìš” ìœ„í—˜ ìš”ì¸ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:';

      // --- ë…¹ë‚´ì¥ ìš”ì¸ ì¹´ë“œ ì—…ë°ì´íŠ¸ ---
      const glaucomaFactorsCard = document.getElementById('glaucomaFactorsCard');
      glaucomaFactorsCard.innerHTML = '';

      const totalAbsoluteCoefficient = data.glaucomaAnalysis.factors.reduce(
        (sum, factor) => sum + Math.abs(factor.coefficient || 0),
        0
      );

      data.glaucomaAnalysis.factors.sort((a, b) => Math.abs(b.coefficient || 0) - Math.abs(a.coefficient || 0)).forEach(factor => {
        const percentage = totalAbsoluteCoefficient > 0 ? (Math.abs(factor.coefficient || 0) / totalAbsoluteCoefficient) * 100 : 0;
        let color = '#6B7280'; // Default color
        if (factor.impact === 'increase') color = '#EF4444'; // Red for increasing risk
        else if (factor.impact === 'decrease') color = '#10B981'; // Green for decreasing risk

        const factorDiv = document.createElement('div');
        factorDiv.style.marginBottom = '16px';
        factorDiv.innerHTML = `
          <div style="font-size: 14px; color: white; margin-bottom: 8px;">${factor.description}</div>
          <div style="width: 100%; height: 8px; background: #1F2937; border-radius: 4px; overflow: hidden;">
            <div style="width: ${percentage}%; height: 100%; background: ${color}; border-radius: 4px;"></div>
          </div>
          <div style="font-size: 12px; color: #9CA3AF; text-align: right; margin-top: 4px;">${percentage.toFixed(1)}%</div>
        `;
        glaucomaFactorsCard.appendChild(factorDiv);
      });

      // --- í™œë™ ê¸°ë¡ ì—…ë°ì´íŠ¸ ---
      const glaucomaActivityLog = document.getElementById('glaucomaActivityLog');
      glaucomaActivityLog.innerHTML = '';

      data.glaucomaAnalysis.recommendations.forEach(rec => {
        const alertBanner = document.createElement('div');
        alertBanner.className = 'alert-banner';
        alertBanner.style.display = 'flex';
        alertBanner.style.alignItems = 'center';
        alertBanner.style.gap = '12px';
        alertBanner.style.padding = '16px';
        alertBanner.style.backgroundColor = glaucomaLevelInfo.bgColor;
        alertBanner.style.borderRadius = '12px';
        alertBanner.style.marginBottom = '12px';
        alertBanner.innerHTML = `
          <div style="width: 32px; height: 32px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: ${glaucomaLevelInfo.bgColor}; font-weight: bold; font-size: 18px;">!</div>
          <div style="font-size: 16px; font-weight: bold; color: white;">${rec}</div>
        `;
        glaucomaActivityLog.appendChild(alertBanner);
      });
    }

    // ì´ˆê¸°í™”
    sensorManager.start();
    updateData();
    // window.addEventListener('sensorUpdate', updateData); // ì •ì  ë°ì´í„°ì´ë¯€ë¡œ í•„ìš” ì—†ìŒ
  </script>
</body>
</html>
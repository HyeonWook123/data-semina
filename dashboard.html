<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëŒ€ì‹œë³´ë“œ - Smart Eye Health</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Sidebar Navigation (Desktop) -->
  <nav class="sidebar-nav">
    <div style="margin-bottom: 32px; padding: 12px;">
      <h2 style="font-size: 20px; font-weight: bold; color: #1D4ED8;">Smart Eye Health</h2>
    </div>
    <a href="index.html" class="nav-item">
      <div class="nav-icon">ğŸ </div>
      <div class="nav-label">í™ˆ</div>
    </a>
    <a href="dashboard.html" class="nav-item active">
      <div class="nav-icon">ğŸ“Š</div>
      <div class="nav-label">ëŒ€ì‹œë³´ë“œ</div>
    </a>
    <a href="smartlens.html" class="nav-item">
      <div class="nav-icon">ğŸ‘“</div>
      <div class="nav-label">ìŠ¤ë§ˆíŠ¸ë Œì¦ˆ</div>
    </a>
    <a href="settings.html" class="nav-item">
      <div class="nav-icon">âš™ï¸</div>
      <div class="nav-label">ì„¤ì •</div>
    </a>
  </nav>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <button class="back-button" onclick="history.back()">â†</button>
      <h1 class="header-title">ë°ì¼ë¦¬ ë¦¬í¬íŠ¸</h1>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="card stat-card">
        <div class="stat-label">í‰ê·  í”¼ë¡œë„</div>
        <div class="stat-value" id="avgFatigue"></div>
      </div>
      <div class="card stat-card">
        <div class="stat-label">ìµœëŒ€ ì•ˆì••</div>
        <div class="stat-value" id="maxPressure"></div>
      </div>
      <div class="card stat-card">
        <div class="stat-label">í‰ê·  ê¹œë¹¡ì„</div>
        <div class="stat-value" id="avgBlink"></div>
      </div>
      <div class="card stat-card">
        <div class="stat-label">ê²½ë³´ íšŸìˆ˜</div>
        <div class="stat-value" style="color: #EF4444;" id="alertCount"></div>
      </div>
    </div>

    <!-- ì£¼ê°„ íŠ¸ë Œë“œ -->
    <div class="section">
      <div class="section-title">ì£¼ê°„ íŠ¸ë Œë“œ</div>
      <div style="display: flex; gap: 8px; margin-bottom: 16px;">
        <button class="btn btn-primary" style="padding: 8px 16px; border-radius: 20px; font-size: 13px;">í”¼ë¡œë„</button>
        <button class="btn btn-secondary" style="padding: 8px 16px; border-radius: 20px; font-size: 13px;">ê²½ë³´ íšŸìˆ˜</button>
        <button class="btn btn-secondary" style="padding: 8px 16px; border-radius: 20px; font-size: 13px;">ê¹œë¹¡ì„ ë¹ˆë„</button>
      </div>

      <div class="card" style="padding: 20px; background: #1F2937; height: 300px;">
        <canvas id="weeklyChart" width="400" height="280" style="width: 100%;"></canvas>
      </div>
    </div>

    <!-- ëˆ„ì  ìœ„í—˜ ì•Œë¦¼ -->
    <div class="section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <div class="section-title" style="margin-bottom: 0;">ëˆ„ì  ìœ„í—˜ ì•Œë¦¼</div>
        <button class="btn btn-secondary" style="padding: 4px 12px; font-size: 13px;">ìµœì‹ ìˆœ â–¼</button>
      </div>

      <div id="cumulativeAlerts">
        <!-- Dynamic content will be inserted here -->
      </div>
    </div>

    <!-- ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸ -->
    <div class="section">
      <div class="section-title">ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸</div>

      <div id="todayInsights">
        <!-- Dynamic content will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item">
      <div class="nav-icon">ğŸ </div>
      <div class="nav-label">í™ˆ</div>
    </a>
    <a href="dashboard.html" class="nav-item active">
      <div class="nav-icon">ğŸ“Š</div>
      <div class="nav-label">ëŒ€ì‹œë³´ë“œ</div>
    </a>
    <a href="smartlens.html" class="nav-item">
      <div class="nav-icon">ğŸ‘“</div>
      <div class="nav-label">ë Œì¦ˆ</div>
    </a>
    <a href="settings.html" class="nav-item">
      <div class="nav-icon">âš™ï¸</div>
      <div class="nav-label">ì„¤ì •</div>
    </a>
  </nav>

  <script src="js/sensor.js"></script>
  <script>
    // í”¼ë¡œë„ ë ˆë²¨ì— ë”°ë¥¸ ìƒ‰ìƒ ë° í…ìŠ¤íŠ¸ ë§¤í•‘ (index.htmlì—ì„œ ê°€ì ¸ì˜´)
    function getFatigueLevelInfo(level) {
      switch (level) {
        case 'Red':
          return { text: 'ë§¤ìš° í”¼ê³¤', bgColor: '#FEE2E2', textColor: '#991B1B', chartColor: '#EF4444' };
        case 'Orange':
          return { text: 'í”¼ê³¤', bgColor: '#FEF3C7', textColor: '#92400E', chartColor: '#F59E0B' };
        case 'Yellow':
          return { text: 'ë³´í†µ', bgColor: '#FFFBEB', textColor: '#B45309', chartColor: '#FFD700' };
        case 'Green':
          return { text: 'ì–‘í˜¸', bgColor: '#D1FAE5', textColor: '#065F46', chartColor: '#10B981' };
        default:
          return { text: 'ì•Œ ìˆ˜ ì—†ìŒ', bgColor: '#F9FAFB', textColor: '#1F2937', chartColor: '#FFB800' };
      }
    }

    // ë…¹ë‚´ì¥ ìœ„í—˜ ë ˆë²¨ì— ë”°ë¥¸ ìƒ‰ìƒ ë° í…ìŠ¤íŠ¸ ë§¤í•‘ (smartlens.htmlì—ì„œ ê°€ì ¸ì˜´)
    function getGlaucomaRiskLevelInfo(level) {
      switch (level) {
        case 'HIGH':
          return { text: 'ë†’ìŒ', bgColor: '#FEE2E2', textColor: '#991B1B', chartColor: '#EF4444' };
        case 'MEDIUM':
          return { text: 'ì¤‘ê°„', bgColor: '#FEF3C7', textColor: '#92400E', chartColor: '#F59E0B' };
        case 'LOW':
          return { text: 'ë‚®ìŒ', bgColor: '#D1FAE5', textColor: '#065F46', chartColor: '#10B981' };
        default:
          return { text: 'ì•Œ ìˆ˜ ì—†ìŒ', bgColor: '#F9FAFB', textColor: '#1F2937', chartColor: '#EF4444' };
      }
    }

    // ì£¼ê°„ íŠ¸ë Œë“œ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    function drawWeeklyChart(dataPoints, color) {
      const canvas = document.getElementById('weeklyChart');
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;

      ctx.clearRect(0, 0, width, height); // ê¸°ì¡´ ì°¨íŠ¸ ì§€ìš°ê¸°

      // ë°°ê²½ ê·¸ë¦¬ë“œ
      ctx.strokeStyle = '#374151';
      ctx.lineWidth = 1;

      for (let i = 0; i <= 5; i++) {
        const y = (i / 5) * height;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
      }

      // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê·¸ë¦¬ì§€ ì•ŠìŒ
      if (dataPoints.length === 0) return;

      // ë¼ì¸ ê·¸ë¦¬ê¸°
      const values = dataPoints.map(d => d.value);
      const max = Math.max(...values);
      const min = Math.min(...values);
      const range = max - min || 1;

      ctx.strokeStyle = color;
      ctx.fillStyle = color;
      ctx.lineWidth = 3;
      ctx.beginPath();

      dataPoints.forEach((point, index) => {
        const x = (index / (dataPoints.length - 1)) * width;
        const y = height - ((point.value - min) / range) * (height - 20); // ìƒë‹¨ ì—¬ë°± 20px

        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }

        // ì  ê·¸ë¦¬ê¸°
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.closePath();

        ctx.beginPath();
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });

      ctx.stroke();
    }

    // í†µê³„ ë° ì¸ì‚¬ì´íŠ¸ ì—…ë°ì´íŠ¸
    function updateDashboard() {
      const data = sensorManager.getCurrent();
      if (!data || !data.fatigueAnalysis || !data.glaucomaAnalysis) return;

      // --- Stats Grid ì—…ë°ì´íŠ¸ ---
      const fatigueLevelInfo = getFatigueLevelInfo(data.fatigueAnalysis.level);
      document.getElementById('avgFatigue').textContent = `${data.fatigueAnalysis.score}%`;
      document.getElementById('avgFatigue').style.color = fatigueLevelInfo.chartColor;

      const glaucomaLevelInfo = getGlaucomaRiskLevelInfo(data.glaucomaAnalysis.level);
      document.getElementById('maxPressure').textContent = `${data.eyePressure} mmHg`;
      document.getElementById('maxPressure').style.color = glaucomaLevelInfo.chartColor;

      document.getElementById('avgBlink').textContent = `${data.blinkRate} íšŒ/ë¶„`;
      document.getElementById('avgBlink').style.color = '#1F2937'; // ê³ ì •

      // ê²½ë³´ íšŸìˆ˜ëŠ” í˜„ì¬ ì •ì  ë°ì´í„°ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„ì‹œ ê°’ ì‚¬ìš©
      document.getElementById('alertCount').textContent = `3 íšŒ`; // ì˜ˆì‹œ ê°’

      // --- ì£¼ê°„ íŠ¸ë Œë“œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ---
      // ì—¬ê¸°ì„œëŠ” sensorHistoryë¥¼ í™œìš©í•˜ì—¬ ì‹¤ì œ ë°ì´í„°ì— ê°€ê¹Œìš´ íŠ¸ë Œë“œë¥¼ ë§Œë“­ë‹ˆë‹¤.
      // ì‹¤ì œ ì£¼ê°„ ë°ì´í„°ê°€ ìˆë‹¤ë©´ í•´ë‹¹ ë°ì´í„°ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
      const weeklyFatigueData = sensorManager.getHistory().slice(-14).map((d, i) => ({ day: `Day ${i + 1}`, value: d.fatigueScore }));
      drawWeeklyChart(weeklyFatigueData, fatigueLevelInfo.chartColor);

      // --- ëˆ„ì  ìœ„í—˜ ì•Œë¦¼ ì—…ë°ì´íŠ¸ ---
      const cumulativeAlertsContainer = document.getElementById('cumulativeAlerts');
      cumulativeAlertsContainer.innerHTML = '';

      // í”¼ë¡œë„ ê¶Œì¥ ì‚¬í•­ì„ ì•Œë¦¼ìœ¼ë¡œ í‘œì‹œ
      data.fatigueAnalysis.recommendations.forEach(rec => {
        const alertCard = document.createElement('div');
        alertCard.className = 'card';
        alertCard.style.display = 'flex';
        alertCard.style.gap = '12px';
        alertCard.style.padding = '16px';
        alertCard.style.marginBottom = '12px';
        alertCard.style.backgroundColor = fatigueLevelInfo.bgColor;
        alertCard.innerHTML = `
          <div style="font-size: 24px;">âš¡</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">í”¼ë¡œë„ ê´€ë ¨ ì•Œë¦¼</div>
            <div style="font-size: 13px; color: #6B7280;">${rec}</div>
          </div>
          <div style="padding: 4px 12px; background: ${fatigueLevelInfo.chartColor}; color: white; border-radius: 12px; font-size: 12px; font-weight: 600; height: fit-content;">${fatigueLevelInfo.text}</div>
        `;
        cumulativeAlertsContainer.appendChild(alertCard);
      });

      // ë…¹ë‚´ì¥ ê¶Œì¥ ì‚¬í•­ì„ ì•Œë¦¼ìœ¼ë¡œ í‘œì‹œ
      data.glaucomaAnalysis.recommendations.forEach(rec => {
        const alertCard = document.createElement('div');
        alertCard.className = 'card';
        alertCard.style.display = 'flex';
        alertCard.style.gap = '12px';
        alertCard.style.padding = '16px';
        alertCard.style.marginBottom = '12px';
        alertCard.style.backgroundColor = glaucomaLevelInfo.bgColor;
        alertCard.innerHTML = `
          <div style="font-size: 24px;">ğŸš¨</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">ë…¹ë‚´ì¥ ìœ„í—˜ ì•Œë¦¼</div>
            <div style="font-size: 13px; color: #6B7280;">${rec}</div>
          </div>
          <div style="padding: 4px 12px; background: ${glaucomaLevelInfo.chartColor}; color: white; border-radius: 12px; font-size: 12px; font-weight: 600; height: fit-content;">${glaucomaLevelInfo.text}</div>
        `;
        cumulativeAlertsContainer.appendChild(alertCard);
      });

      // --- ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸ ì—…ë°ì´íŠ¸ ---
      const todayInsightsContainer = document.getElementById('todayInsights');
      todayInsightsContainer.innerHTML = '';

      // í”¼ë¡œë„ ì¸ì‚¬ì´íŠ¸
      data.fatigueAnalysis.factors.forEach(factor => {
        const insightCard = document.createElement('div');
        insightCard.className = 'card';
        insightCard.style.display = 'flex';
        insightCard.style.gap = '12px';
        insightCard.style.padding = '16px';
        insightCard.style.marginBottom = '12px';
        insightCard.style.backgroundColor = factor.impact === 'increase' ? '#FEE2E2' : '#D1FAE5';
        insightCard.innerHTML = `
          <div style="font-size: 24px;">${factor.impact === 'increase' ? 'âŒ' : 'ğŸ‘'}</div>
          <div>
            <div style="font-weight: 600; margin-bottom: 4px;">${factor.description}</div>
            <div style="font-size: 13px; color: #4B5563; line-height: 1.4;">
              ${factor.impact === 'increase' ? 'í˜„ì¬ ' + factor.description + 'ìœ¼ë¡œ ì¸í•´ í”¼ë¡œë„ê°€ ì¦ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤.' : 'í˜„ì¬ ' + factor.description + 'ì€(ëŠ”) í”¼ë¡œë„ ê°ì†Œì— ê¸ì •ì ì¸ ì˜í–¥ì„ ë¯¸ì¹˜ê³  ìˆìŠµë‹ˆë‹¤.'}
            </div>
          </div>
        `;
        todayInsightsContainer.appendChild(insightCard);
      });

      // ë…¹ë‚´ì¥ ì¸ì‚¬ì´íŠ¸
      data.glaucomaAnalysis.factors.forEach(factor => {
        const insightCard = document.createElement('div');
        insightCard.className = 'card';
        insightCard.style.display = 'flex';
        insightCard.style.gap = '12px';
        insightCard.style.padding = '16px';
        insightCard.style.marginBottom = '12px';
        insightCard.style.backgroundColor = factor.impact === 'increase' ? '#FEE2E2' : '#D1FAE5';
        insightCard.innerHTML = `
          <div style="font-size: 24px;">${factor.impact === 'increase' ? 'ğŸš¨' : 'âœ…'}</div>
          <div>
            <div style="font-weight: 600; margin-bottom: 4px;">${factor.description}</div>
            <div style="font-size: 13px; color: #4B5563; line-height: 1.4;">
              ${factor.impact === 'increase' ? 'í˜„ì¬ ' + factor.description + 'ìœ¼ë¡œ ì¸í•´ ë…¹ë‚´ì¥ ìœ„í—˜ì´ ì¦ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤.' : 'í˜„ì¬ ' + factor.description + 'ì€(ëŠ”) ë…¹ë‚´ì¥ ìœ„í—˜ ê°ì†Œì— ê¸ì •ì ì¸ ì˜í–¥ì„ ë¯¸ì¹˜ê³  ìˆìŠµë‹ˆë‹¤.'}
            </div>
          </div>
        `;
        todayInsightsContainer.appendChild(insightCard);
      });
    }

    // ì´ˆê¸°í™”
    sensorManager.start();
    updateDashboard();

    // window.addEventListener('sensorUpdate', updateDashboard); // ì •ì  ë°ì´í„°ì´ë¯€ë¡œ í•„ìš” ì—†ìŒ
  </script>
</body>
</html>